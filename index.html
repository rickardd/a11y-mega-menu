<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>Accessible Mega Menu</title>
        
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

        <style>
            
            ul {
                list-style: none;
                padding: 0;
                margin: 0 0 24px 0 !important; 
            }

            li {
                margin-bottom: 6px;
            }

            

            a {
                color: #fff;
                text-decoration: none;
            }

            .header {
                position: relative;
            }

            
            /* MOBILE MENU */

            .header-nav {
                position: fixed;
                width: 100vw;
                /* max-width: 400px; */
                right: 0;
                transform: translateX(100%);
                transition: 300ms transform ease;
                min-height: 100vh;
                background: gray;
            }

            .header-nav-open {
                transform: translateX(0);
                transition: 300ms transform ease;
            }

            .mega-menu-mobile-header {
                padding: 24px;
                background: #fff;
            }

            .mega-menu{
                position: relative;
            }

            .mega-menu-button {
                background: #eee;
                border: none;
                display: block;
                width: 100%;
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #aaa;
            }

            .mega-menu-popup {
                position: fixed;
                right: -100%;
                background: #555;
                padding: 0;
                top: 0;
                min-height: 100vh;
                width: 100vw;
            }

            .mega-menu-popup-open {
                z-index: 100;
            }

            .mega-menu-level {
                transform: translateX(0);
                transition: 300ms transform ease;
                position: absolute;
                right: -100%;
                height: 100vh;
                width: 100vw;
            }

            .mega-menu-level-2-link {
                display: none;
            }

            .mega-menu-level-2-button {
                display: inline-block;
            }
            
            .mega-menu-level-3 {
                position: absolute;
                right: 0;
                background: #777;
                top: 0;
                bottom: 0;
                padding: 24px;
            }

            .mega-menu-level-active {
                transform: translateX(-100%);
                transition: 300ms transform ease;
            }


            
            /* DESKTOP */

            @media (min-width: 800px) {

                .header-nav {
                    position: static;
                    width: 100%;
                    max-width: 100%;
                    min-height: 0;
                    transform: none;
                    transition: none;
                }

                .mega-menu-mobile-header {
                    display: none;
                }

                .mega-menu {
                    position: static;
                }

                .mega-menu-list {
                    display: flex;
                }

                .mega-menu-list-item:not(:last-child) {
                    margin-right: 24px;
                }

                .mega-menu-button {
                    border-radius: 0;
                    background-color: #666;
                    color: #fff;
                    padding: 12px;
                }

                .mega-menu-button[aria-expanded="true"] {
                    background-color: #fff;
                    color: #666;
                }

                .mega-menu a:focus {
                    outline: 2px solid red !important;
                }

                .mega-menu-popup {
                    position: absolute;
                    top: auto;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    transform: translateY(100%);
                    padding: 24px;
                    background: #ccc;
                    color: white;
                    display: none;
                    min-height: 0;
                    padding: 24px;
                }

                .mega-menu-popup-open {
                    display: block;
                }

                .mega-menu-level {
                    width: auto;
                    min-height: auto;
                    height: auto;                
                }

                .mega-menu-level-2-link {
                    display: inline-block;
                }

                .mega-menu-level-2-button {
                    display: none;
                }

                .mega-menu-level-3 {
                    position: static;
                    padding: 0;
                    display: inline-block;
                }

                
            }
            

        </style>

        <script>

            class MegaMenu {
                constructor(container) {
                    this.container = container;
                    this.levels = container.querySelectorAll('.mega-menu-level')
                    this.buttons = container.querySelectorAll('.mega-menu-button')
                    // change to container once placed correctly
                    this.mobileToggleButton = document.querySelector('.js-mega-menu-mobile-toggle')
                    this.mobileCloseButton = document.querySelector('.js-mega-menu-mobile-close')
                    this.headerNav = document.querySelector('.js-header-nav')
                    this.bindButtonsClick()
                    this.bindMobileToggleButtonClick()
                    this.bindMobileCloseButtonClick()
                    this.bindDocumentClick()
                    this.bindKeyPress()
                    
                }
                
                // Closes menu if click outside it.
                onDocumentClick( event ) {
                    const target = event.target                    
                    if (this.container !== target && !this.container.contains(target)) {
                        this.setExpandAll(false)
                        this.closeAll()
                    }
                }

                onKeyUp() {
                    this.setFocus('previous')  
                }

                onKeyDown() {
                    this.setFocus('next')  
                    this.ensureFocus()
                }

                onKeyRight() {
                    this.setFocusGroup('next')
                }

                onKeyLeft() {
                    this.setFocusGroup('previous')
                }

                onKeyEsc() {
                    this.setExpandAll(false)
                    this.closeAll()
                }

                getExpandedButton() {
                    return Array.from(this.buttons).filter( button => button.getAttribute('aria-expanded') === 'true')[0]
                }

                getPopup(button) {
                    const item = button.closest('li')
                    const popup = item.querySelector('.mega-menu-popup')
                    return popup
                }

                getFocusedLink(){
                    const focusedElement = document.activeElement
                    // might need to check if the links is inside the mega menu as well. 
                    if(this.isElement(focusedElement, 'a')){
                        return focusedElement
                    }
                }

                setExpanded(button, value) {
                    button.setAttribute('aria-expanded', value)
                }

                setExpandAll(value) {
                    this.buttons.forEach( button => {
                        this.setExpanded(button, value)
                    })
                }

                ensureFocus() {
                    const link = this.getFocusedLink()
                    if(!link){
                        const button = this.getExpandedButton()
                        const popup = this.getPopup(button)
                        this.setFocusOnFirstLink(popup)
                    }
                }
                
                setFocusOnFirstLink(popup){
                    popup.querySelector('.js-mega-menu-link').focus()
                }

                setFocus( direction ) {
                    const link = this.getFocusedLink()
                    if(!link){
                        return
                    }
                    const parentLi = link.closest('li')
                    const nextLi = direction === 'previous' ? parentLi.previousElementSibling :  parentLi.nextElementSibling
                    if(nextLi){
                        nextLi.querySelector('.js-mega-menu-link').focus()
                    }
                    else{
                        if( direction === 'previous' ) {
                            this.setFocusGroup('previous', 'last')
                        }
                        else{
                            this.setFocusGroup('next')
                        }
                    }
                }
                
                setFocusGroup( direction, startingPoint ) {
                    const link = this.getFocusedLink()
                    if(!link){
                        return
                    }
                    const parentUl = link.closest('ul')
                    
                    const nextUl = direction === 'previous' ? parentUl.previousElementSibling :  parentUl.nextElementSibling
                    if(nextUl){
                        if( startingPoint === 'last') {
                            const lis = nextUl.querySelectorAll('li')
                            const lastLi = lis[lis.length -1]
                            lastLi.querySelector('.js-mega-menu-link').focus()
                        }
                        else{
                            nextUl.querySelector('li .js-mega-menu-link').focus()
                        }
                    }
                }

                isElement(el, value) {
                    return el.nodeName.toLocaleLowerCase() === value
                }

                isAnyPopupOpen() {
                    return !!this.container.querySelector('.mega-menu-popup-open')
                    
                }

                onButtonClick( event ) {
                    const button = event.target
                    const isPressed = button.getAttribute('aria-expanded') === 'true';
                    const isOtherPressed = !!Array.from(this.buttons).filter( b => b.getAttribute('aria-expanded') === 'true').length
                    const popup = this.getPopup(button)
                    const parentListItem = button.closest('.mega-menu-list-item')
                    
                    this.setExpandAll(false)
                    this.closeAll()
                    
                    if(!isPressed){
                        this.setExpanded(button, true)
                        this.open(popup)
                        this.setFocusOnFirstLink(popup)
                    }
                    
                    parentListItem.querySelector('.mega-menu-level').classList.add('mega-menu-level-active')
                }

                onMobileToggleButtonClick( event ) {
                    const button = event.target
                    const isPressed = button.getAttribute('aria-expanded') === 'true';
                    if(isPressed){
                        button.setAttribute('aria-expanded', false);
                        this.mobileClose()
                    }
                    else {
                        button.setAttribute('aria-expanded', true);
                        this.mobileOpen()
                    }
                }

                onMobileCloseButtonClick( event ) {
                    this.mobileClose()
                    this.mobileToggleButton.setAttribute('aria-expanded', false);
                }
                
                // Automatically close menus when the user clicks away.
                bindDocumentClick() {
                    document.addEventListener( 'click', this.onDocumentClick.bind(this) );
                }

                bindButtonsClick(button) {
                    this.buttons.forEach( button => {
                        button.addEventListener( 'click', this.onButtonClick.bind(this) );
                    })
                }

                bindMobileToggleButtonClick() {
                    this.mobileToggleButton.addEventListener( 'click', this.onMobileToggleButtonClick.bind(this) );
                }

                bindMobileCloseButtonClick() {
                    this.mobileCloseButton.addEventListener( 'click', this.onMobileCloseButtonClick.bind(this) );
                }

                bindKeyPress(){
                    document.addEventListener("keydown", function(event) {
                        if(!this.isAnyPopupOpen()){
                            return
                        }
                        
                        const key = event.which || event.keyCode || 0;
                    
                        switch (key) {
                            case 38:
                                this.onKeyUp()
                                break
                            case 40:
                                this.onKeyDown()
                                break
                            case 39:
                                this.onKeyRight()
                                break
                            case 37:
                                this.onKeyLeft()
                                break
                            case 27: 
                                this.onKeyEsc()
                                break
                        }
                    }.bind(this))
                }

                open(popup) {
                    popup.classList.add('mega-menu-popup-open')
                }

                close(popup) {
                    popup.classList.remove('mega-menu-popup-open')
                }


                mobileOpen() {
                    this.headerNav.classList.add('header-nav-open')
                }

                mobileClose() {
                    this.headerNav.classList.remove('header-nav-open')

                    // wait for animation done bofore removing
                    this.levels.forEach( level => {
                        level.classList.remove('mega-menu-level-active')
                    })
                }

                closeAll() {
                    this.buttons.forEach( button => {
                        const popup = this.getPopup(button)
                        this.close(popup)
                    })
                }
            }

            function init() {
                const megaMenu = document.querySelector('.mega-menu');
                new MegaMenu(megaMenu)
            }

            document.addEventListener('DOMContentLoaded', function(event) {
                init();
            })

        </script>


    </head>

    <body>


        <style>
            .bg-1 {
                background-color: #aaa;
            }
            .bg-2 {
                background-color: #bbb;
            }
            .bg-3 {
                background-color: #ccc;
            }
            .bg-4 {
                background-color: #ddd;
            }
            .bg-5 {
                background-color: #eee;
            }
            .bg-6 {
                background-color: #999;
            }

        </style>

        <div class="container-fluid header bg-5">
            <div class="row">
                <div class="col-md-3 bg-1">
                    <div class="bg-6">
                        Logo
                    </div>
                </div>
                <div class="col-md-9 bg-2 position-static">
                    <div class="header-nav js-header-nav">
                        <div class="mb-12 bg-3">
                            Maps | Careers | Contact
                        </div>
                        <div class="mega-menu-mobile-header">
                            <input type="search" class="hidden-md" placeholder="Search">
                            <button class="js-mega-menu-mobile-close">Menu</button>
                        </div>
                        <div class="mb-12 bg-4">
                            <nav class="mega-menu">
                                <!-- LEVEL 1 -->
                                <ul class="mega-menu-list">
                                    <li class="mega-menu-list-item">
                                        <button class="mega-menu-button" aria-pressed="false" aria-haspopup="true" aria-expanded="false" aria-controls="mega-menu-popup-1">Menu 1</button>
                                        <!-- LEVEL 2 -->
                                        <div class="mega-menu-level mega-menu-level-2 mega-menu-popup" id="mega-menu-popup-1">
                                            <div class="mega-menu-list-item">
                                                <div class="mega-menu-list-header">
                                                    <h1 class="h3 mega-menu-level-2-link">
                                                        <a href="" class="">Title 1 link</a>
                                                    </h1>
                                                    <button class="mega-menu-button mega-menu-level-2-button">Title 1 button</button>
                                                </div>
                                                <!-- LEVEL 3 -->
                                                <div class="mega-menu-level mega-menu-level-3">
                                                    <ul role="menu">
                                                        <li class="mega-menu__item" role="menuitem">
                                                            <a class="js-mega-menu-link" tabindex="-1" href="#">Item 1</a>
                                                        </li>
                                                        <li class="mega-menu__item" role="menuitem">
                                                            <a class="js-mega-menu-link" tabindex="-1" href="#">Item 2</a>
                                                        </li>
                                                        <li class="mega-menu__item" role="menuitem">
                                                            <a class="js-mega-menu-link" tabindex="-1" href="#">Item 3</a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                            
                                            <div class="mega-menu-list-item">
                                                <div class="mega-menu-list-header">
                                                    <h1 class="h3 mega-menu-level-2-link">
                                                        <a href="" class="">Title 2 link</a>
                                                    </h1>
                                                </div>
                                                <button class="mega-menu-button mega-menu-level-2-button">Title 2 button</button>
                                                <div class="mega-menu-level mega-menu-level-3">
                                                    <ul role="menu">
                                                        <li class="mega-menu__item" role="menuitem">
                                                            <a class="js-mega-menu-link" tabindex="-1" href="#">Item 2-1</a>
                                                        </li>
                                                        <li class="mega-menu__item" role="menuitem">
                                                            <a class="js-mega-menu-link" tabindex="-1" href="#">Item 2-2</a>
                                                        </li>
                                                        <li class="mega-menu__item" role="menuitem">
                                                            <a class="js-mega-menu-link" tabindex="-1" href="#">Item 2-3</a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>

                                        </div>
                                    </li>
                                    <li class="mega-menu-list-item">
                                        <button class="mega-menu-button" aria-pressed="false" aria-haspopup="true" aria-expanded="false" aria-controls="mega-menu-popup-2">Menu 2</button>
                                        <div class="mega-menu-level mega-menu-level-2 mega-menu-popup" id="mega-menu-popup-2">
                                            <ul role="menu">
                                                <li class="mega-menu__item" role="menuitem">
                                                    <a class="js-mega-menu-link" tabindex="-1" href="#">Item A</a>
                                                </li>
                                                <li class="mega-menu__item" role="menuitem">
                                                    <a class="js-mega-menu-link" tabindex="-1" href="#">Item B</a>
                                                </li>
                                                <li class="mega-menu__item" role="menuitem">
                                                    <a class="js-mega-menu-link" tabindex="-1" href="#">Item C</a>
                                                </li>
                                            </ul>
                    
                                            <ul role="menu">
                                                <li class="mega-menu__item" role="menuitem">
                                                    <a class="js-mega-menu-link" tabindex="-1" href="#">Item D</a>
                                                </li>
                                                <li class="mega-menu__item" role="menuitem">
                                                    <a class="js-mega-menu-link" tabindex="-1" href="#">Item E</a>
                                                </li>
                                                <li class="mega-menu__item" role="menuitem">
                                                    <a class="js-mega-menu-link" tabindex="-1" href="#">Item F</a>
                                                </li>
                                            </ul>
                                            
                                        </div>
                                    </li>
                                </ul>
                                
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <style>
            #button {
                position: fixed;
                bottom: 24px;
                left: 24px;
            }
            #button2 {
                position: fixed;
                bottom: 24px;
                left: 124px;
            }
        </style>
        <button id="button" class="js-mega-menu-mobile-toggle">Menu</button>
        <script>
            // document.querySelector('#button').addEventListener('click', () => {
            //     document.querySelector('.js-header-nav').classList.toggle('header-nav-open')
            // })
        </script>

    </body>
</html>